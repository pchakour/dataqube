# !/bin/sh

dirname="$(dirname "$0")"
root_dir=${dirname}/..
directory_path=${root_dir}/vendor/bundle/ruby
ruby_version=$(find "$directory_path" -mindepth 1 -maxdepth 1 -type d -printf "%f\n")
gem_repository=$(realpath ${directory_path}/${ruby_version})

if [ -z "${RUBY_BIN}" ]; then
  RUBY_BIN="ruby"
fi

GEM_PATH=${gem_repository} ${RUBY_BIN} ${root_dir}/src/dataqube-parser/src/main.rb $@ &
PID=$!

handle_sigterm() {
   echo "SIGTERM received, exiting now"
   kill -15 $PID
   exit 143
}

handle_sigint() {
   echo "SIGINT received, exiting now"
   kill -15 $PID
   exit 130
}

handle_sigkill() {
   echo "SIGKILL received, exiting now"
   kill -15 $PID
   exit 137
}

trap handle_sigterm TERM
trap handle_sigint INT
trap handle_sigkill KILL

wait $PID
